# üè° Mas de L‚ÄôOm ‚Äì Internal App

The internal management platform for **Mas de L‚ÄôOm**, rebuilt with **Next.js 14**, **Drizzle ORM**, and **Neon PostgreSQL**.  
This app manages **projects**, **tasks**, **materials**, **logs**, and **calendars**, with secure **role-based access** and invite-based onboarding.

---

## üöÄ Stack

| Layer | Technology |
|-------|-------------|
| Frontend | [Next.js 14](https://nextjs.org) (App Router) |
| Database | [Neon PostgreSQL](https://neon.tech) (serverless) |
| ORM | [Drizzle ORM](https://orm.drizzle.team) |
| Auth | JWT (signed with `jose`), bcrypt for passwords |
| UI | React 18 + SWR + Tailwind (if configured) |
| Deployment | [Vercel](https://vercel.com) |

---

## üß© Project Structure

```
app/
  api/
    auth/
      bootstrap/route.ts     # one-time seed of SUPER user
    invites/                 # invite creation & acceptance
    users/me/                # returns current authenticated user
    projects/                # CRUD for projects
    tasks/                   # CRUD for tasks
    materials/               # materials inventory
    logs/                    # daily journal/logbook
    events/                  # unified calendar feed
lib/
  db.ts                      # Neon + Drizzle connection
  schema.ts                  # all table definitions
  auth.ts                    # session & role utilities
.env.local                   # local environment variables
```

---

## ‚öôÔ∏è Environment Variables

Create a `.env.local` file for local dev:

```bash
# ============ Core ============
SITE_NAME="Mas de L'Om (Internal)"
JWT_SECRET="super-long-random-string"
BASE_URL="http://localhost:3000"
DEFAULT_LANG="en"
NODE_ENV="development"

# ============ Bootstrap SUPER ============
BOOTSTRAP_SUPERADMIN_EMAIL="admin@example.com"
BOOTSTRAP_SUPERADMIN_PASSWORD="ChangeMe!123"
BOOTSTRAP_SUPERADMIN_NAME="John"

# ============ Database (Neon) ============
DATABASE_URL="postgresql://user:password@host/db?sslmode=require"
```

In **Vercel**, set these same keys in Project ‚Üí Settings ‚Üí Environment Variables.  
If you used the Neon template, make sure **`DATABASE_URL`** points to your pooled SSL connection.

---

## üß± Database Setup

### 1. Install dependencies
```bash
pnpm add drizzle-orm @neondatabase/serverless bcryptjs
pnpm add -D drizzle-kit
```

### 2. Generate Drizzle config
Create `drizzle.config.ts`:

```ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  schema: "./lib/schema.ts",
  out: "./drizzle",
  dialect: "postgresql",
  dbCredentials: { url: process.env.DATABASE_URL! },
});
```

### 3. Generate SQL migrations
```bash
pnpm db:generate
```

### 4. Push schema to Neon
```bash
pnpm db:push
```

### 5. Optional: open Drizzle Studio
```bash
pnpm db:studio
```

---

## üë§ Bootstrap the SUPER User

Run **once** (locally or on Vercel) to seed the first super-admin:

```bash
curl -X POST https://<your-domain>/api/auth/bootstrap
```

If successful, you‚Äôll get:
```json
{ "ok": true, "role": "SUPER" }
```

This account uses credentials from your `.env` file:
```
BOOTSTRAP_SUPERADMIN_EMAIL / PASSWORD / NAME
```

---

## üîë Authentication Flow

- Login endpoint checks `users` table via Drizzle and issues a JWT.
- Cookie stores the session; `lib/auth.ts` exposes `currentUser()` and `requireRole()`.
- Roles: `SUPER`, `ADMIN`, `STAFF`.
- Invites are one-time tokens generated by ADMIN or SUPER via `/api/invites`.

---

## üóìÔ∏è Calendar System

`/api/events` merges data from **projects** and **tasks** for scheduling.

Query parameters:
```
?scope=mine|all&from=YYYY-MM-DD&to=YYYY-MM-DD
```
- Admins see all events; normal users see only their own.
- PATCH supports drag-and-drop updates.

---

## üîî Notifications (coming soon)

The service worker will support:
- Push notifications for task updates and calendar events
- Offline caching for PWA use
- ‚ÄúInstall App‚Äù prompt for desktop/mobile

---

## üß∞ Scripts

| Command | Purpose |
|----------|----------|
| `pnpm dev` | Run local dev server |
| `pnpm build` | Build Next.js app |
| `pnpm start` | Start in production mode |
| `pnpm seed` | (if added) run seed script |
| `pnpm db:generate` | Generate Drizzle SQL |
| `pnpm db:push` | Push schema to DB |
| `pnpm db:studio` | Visual DB browser |

---

## üßæ Deployment on Vercel

1. Push repo to GitHub/GitLab.
2. Import in [Vercel](https://vercel.com).
3. Set all required env vars.
4. Use **Node 20+** runtime.
5. Re-deploy.  
   If Neon isn‚Äôt found, double-check `DATABASE_URL`.

To verify connection after deploy:
```
curl https://<your-vercel-domain>/api/projects
```
If you get JSON, Drizzle + Neon are connected.

---

## üß† Developer Notes

- All API routes use **`export const runtime = "nodejs"`** (required for Neon HTTP driver).
- You can safely remove all legacy LowDB code.
- To rename the instance everywhere, set `SITE_NAME="Mas de L'Om"`.
- Avoid trailing locale in `BASE_URL` (`https://masdelom.vercel.app` ‚úÖ, `https://masdelom.vercel.app/en` ‚ùå).

---

## ü©µ License & Attribution

This codebase is owned by **Mas de L‚ÄôOm**  
Maintained by [@psyfire25](https://github.com/psyfire25)  

Built with ‚ù§Ô∏è on Next.js and Drizzle.
